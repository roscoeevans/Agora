---
description: When implementing SwiftUI views in local Swift Package Manager (SPM) packages (Features/Kits/Shared), adding #Preview blocks for live canvas development, troubleshooting preview canvas issues, setting up preview dependencies and mocks, configuring package resources for previews, or understanding how Xcode 26+ resolves preview hosts for modular iOS apps. Use this when creating new SwiftUI views in packages, debugging "Cannot preview" errors, or setting up preview infrastructure.
---

## SwiftUI Previews in Local SPM Packages

### Intent
Enable SwiftUI `#Preview` blocks **inside local SPM packages** (Features/Kits/Shared) so developers can see live previews right where views are defined, without a separate preview app. Xcode 26 resolves the **Agora** app as the host _if_ the app links the package product.

### Scope
- Applies to all SwiftUI views in `Packages/Features/**`, `Packages/Kits/**`, and (sparingly) `Packages/Shared/**`.
- Does **not** apply to remote Git packages (previews require a local package + host app).
- Works with iOS 26 / Swift 6.2+.

---

## Ground Rules (TL;DR)

1. **The app must link the package product** you want to preview.  
2. Put `#Preview { ... }` **in the package file next to the view**.  
3. Use `PreviewDeps.scoped { ... }` to inject safe mocks and a minimal environment.  
4. Guard heavy startup with `ProcessInfo.processInfo.isiOSPreviews`.  
5. Package assets live in `Resources/` and are declared in `Package.swift` with `.process("Resources")`.

---

## How It Works (one-time wiring)

### 1) App target links package products

In **Agora (app) → Build Phases → Link Binary With Libraries**, add any package products that you want to preview:
- `Features/HomeForYou`, `Features/Auth`, …
- `Kits/DesignSystem`, `Kits/Media`, …
- `Shared/AppFoundation` (already linked)

> This is what lets Xcode pick **Agora** as the host when it sees `#Preview` inside the package.

### 2) Lightweight preview helpers (Shared/AppFoundation)

**File:** `Packages/Shared/AppFoundation/Sources/AppFoundation/PreviewDeps.swift`

```swift
import SwiftUI

public enum PreviewDeps {
    /// Wrap any preview in a safe DI/environment context.
    @ViewBuilder
    public static func scoped<V: View>(@ViewBuilder _ content: () -> V) -> some View {
        content()
            .environment(\.locale, .init(identifier: "en_US"))
            .environment(\.colorScheme, .light)
            // Example: inject your DI container or mock services if you use EnvironmentKeys.
            // .environment(AppServicesKey.self, .mocks)
    }
}
```

**File:** `Packages/Shared/AppFoundation/Sources/AppFoundation/ProcessInfo+Previews.swift`

```swift
import Foundation

public extension ProcessInfo {
    var isiOSPreviews: Bool {
        environment["XCODE_RUNNING_FOR_PREVIEWS"] == "1"
    }
}
```

Anywhere you have heavy boot code (analytics, network warmups, push setup), guard with:

```swift
guard !ProcessInfo.processInfo.isiOSPreviews else { return }
```

### 3) Package assets (if your view needs them)

In each package's `Package.swift`:

```swift
.target(
  name: "DesignSystem",
  resources: [
    .process("Resources")
  ]
),
```

Put colors/images/fonts in `Packages/Kits/DesignSystem/Resources/**` (or a feature's `Resources/`).
SwiftUI will load from `Bundle.module` automatically for `.xcassets`.

---

## In-Package Usage Pattern (author previews where you code)

**Example:** `Packages/Features/HomeForYou/Sources/HomeForYou/FeedView.swift`

```swift
import SwiftUI
import AppFoundation // for PreviewDeps

public struct FeedView: View {
    public init() {}
    
    public var body: some View {
        Text("For You")
            .font(.title.weight(.semibold))
    }
}

@available(iOS 26.0, *)
#Preview("Default") {
    PreviewDeps.scoped {
        FeedView()
            .padding()
            .previewLayout(.sizeThatFits)
    }
}
```

### Multiple States in One Place (recommended)

```swift
#Preview("Empty") {
    PreviewDeps.scoped { FeedView() /* with empty state */ }
}

#Preview("Loading") {
    PreviewDeps.scoped { FeedView() /* with loading state */ }
}

#Preview("Error") {
    PreviewDeps.scoped { FeedView() /* with mock error */ }
}
```

**Naming:** Keep previews next to the view file or in a `Previews/` subgroup. See `ios-naming.mdc` for file names; no separate "PreviewApp" target is required.

---

## Do / Don't

### ✅ Do

- Keep previews co-located with the view they exercise.
- Build fixture models inside each feature (`PreviewModels.swift`) to avoid cross-module runtime coupling.
- Use `PreviewDeps.scoped` to ensure consistent color scheme/locale/mocks.
- Keep previews pure: no real network/analytics; rely on mocks.
- Prefer `.sizeThatFits` or fixed frames for deterministic snapshots.

### ❌ Don't

- Don't add previews to remote Git packages (they won't run).
- Don't rely on app-global side effects (push, analytics, live DB) in a preview.
- Don't access app `Info.plist` or entitlements directly from a package preview.

---

## Integration With Other Rules

### Module Standards (ios-module-standards.mdc)
Add a "Resources" subsection noting `.process("Resources")` and asset loading expectations for previewable UI.

### DI (ios-di-injection.mdc)
Add a `Mocks` or `PreviewContainer` pattern referenced by `PreviewDeps`.

### Naming (ios-naming.mdc)
Add guidance: co-locate preview blocks; optional `Previews/` subgroup; name examples `ThingView.preview.swift` if split.

---

## Troubleshooting

### Canvas says "Cannot preview" or build fails

1. Make sure the **Agora** app links the package product.
2. Build the app once (`⌘B`) so Xcode indexes; then retry Canvas (`⌥⌘↩︎`).
3. Clean Build Folder (`Shift-⌘-K`) if symbols changed.

### "No such module …" in preview

The module isn't linked by the app or the scheme isn't building the right graph.

### Assets missing

Ensure `Resources/` is declared with `.process("Resources")` in the package target.

### Slow or crashing previews

- Guard heavy init with `isiOSPreviews`.
- Move complex data to `PreviewModels` and use tiny fixtures.

---

## Migration Plan (30–60 min)

1. Add `PreviewDeps.swift` and `ProcessInfo+Previews.swift` to `AppFoundation`.
2. Link your most-used UI packages to the **Agora** app target.
3. Add one `#Preview` block to:
   - `Kits/DesignSystem` (e.g., Button showcase),
   - `Features/HomeForYou` (main screen),
   - `Features/PostDetail` (with `PreviewModels.samplePost`).
4. Build app once; open those files; enable Canvas.

---

## FAQs

**Q: Do I need a separate PreviewHost app target?**  
A: Not required. If the main app is heavy, an optional "PreviewHost" app can speed things up, but this rule assumes the main app hosts previews.

**Q: Can previews reference TestSupport?**  
A: Yes, but keep Preview APIs public where needed. Prefer minimal, package-local fixtures.

**Q: CI & snapshots?**  
A: This rule is about developer previews. For image snapshots in CI, follow the guidance in `swiftui-snapshot-testing.mdc` (Point-Free library, deterministic sizes, etc.).

---

## Quick Templates

### Preview Fixture (inside a Feature)

```swift
public enum PreviewModels {
    public static let samplePost = Post(
        id: "p1", 
        author: "rocky", 
        text: "Human-only social ✨"
    )
}
```

### Design System Showcase

```swift
public struct ButtonShowcase: View {
    public init() {}
    
    public var body: some View {
        VStack(spacing: 12) {
            PrimaryButton(title: "Primary")
            SecondaryButton(title: "Secondary")
        }
        .padding()
    }
}

#Preview("DesignSystem — Buttons") {
    PreviewDeps.scoped { 
        ButtonShowcase()
            .previewLayout(.sizeThatFits) 
    }
}
```

---

## Optional Cross-Rule Updates (suggested)

- **ios-module-standards.mdc** → Add a "Resources for Previews" bullet with `.process("Resources")`.
- **ios-di-injection.mdc** → Add a `Mocks`/`PreviewContainer` recommendation and mention `PreviewDeps`.
- **ios-naming.mdc** → Add preview file naming guidance (co-located vs. `Previews/` subgroup).

