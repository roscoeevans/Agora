---
description: When building and testing the Agora iOS app, ensuring compilation success and identifying which modules break when changes are made. This rule provides comprehensive build verification, module-specific testing, and error diagnosis for the Swift Package Manager-based modular architecture.
alwaysApply: false
---

## iOS Build and Testing Guidelines

### Overview

This rule provides comprehensive guidance for building and testing the Agora iOS app, ensuring compilation success while enabling granular testing to identify exactly what breaks when changes are made. The app uses a modular Swift Package Manager architecture with Features, Kits, and Shared packages, requiring both individual module testing and integration testing.

**Primary Tool**: Use `agctl` (Agora's CLI tool) for all module-level operations (build, test, validate). Use `xcodebuild` for main app target operations and UI tests.

### ⚠️ CRITICAL: agctl Usage

**agctl is a standalone command-line tool installed at `/usr/local/bin/agctl`**

✅ **CORRECT Usage:**
```bash
agctl build
agctl build Compose
agctl test
agctl test Networking
agctl validate modules
```

❌ **WRONG - NEVER DO THIS:**
```bash
# DO NOT use swift run with package-path
swift run --package-path Tools/agctl agctl build  # ❌ WRONG
cd Tools/agctl && swift run agctl build           # ❌ WRONG
```

**How to verify agctl is installed:**
```bash
which agctl    # Should output: /usr/local/bin/agctl
agctl --version
```

**If agctl is not installed:**
```bash
cd Tools/agctl
./install.sh
agctl install-hooks  # Install git hooks for automatic validation
```

### agctl - Agora Command Line Tool

`agctl` is the primary tool for module operations. It provides a unified interface for building, testing, and validating packages.

#### Quick Reference

```bash
# Build specific module
agctl build AuthFeature
agctl build DesignSystem

# Build all modules
agctl build

# Test specific module
agctl test AuthFeature
agctl test Networking

# Test all modules
agctl test

# Validate project structure
agctl validate modules
agctl validate dependencies

# Generate OpenAPI client
agctl generate openapi

# Clean build artifacts
agctl clean

# Deep clean (includes DerivedData and caches)
agctl clean --all
```

For full documentation, see:
- `Tools/agctl/README.md` - Command reference
- `docs/AGCTL_GUIDE.md` - Complete workflows
- Run `agctl --help` for built-in help

### Build Verification Commands

#### 1. **Quick Compilation Check**
Use these commands to verify the app compiles without running tests:

```bash
# Build main app target (use xcodebuild)
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -quiet

# Build all packages (PREFERRED: use agctl)
agctl build

# Build specific modules (PREFERRED: use agctl)
agctl build Compose
agctl build DesignSystem
agctl build AppFoundation

# Alternative: Direct swift commands
swift build --package-path Packages/Features/Compose
swift build --package-path Packages/Kits/DesignSystem
swift build --package-path Packages/Shared/AppFoundation
```

#### 2. **Full Build Verification**
For comprehensive build verification:

```bash
# Clean and build everything
xcodebuild clean build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -configuration Debug

# Build for release
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -configuration Release
```

### Module-Specific Testing

#### 1. **Individual Package Testing**
Test specific modules when changes are made:

```bash
# PREFERRED: Use agctl for module testing
agctl test Compose
agctl test HomeForYou
agctl test Profile
agctl test DesignSystem
agctl test Networking
agctl test AppFoundation
agctl test TestSupport

# Alternative: Direct swift commands
swift test --package-path Packages/Features/Compose
swift test --package-path Packages/Features/HomeForYou
swift test --package-path Packages/Features/Profile
swift test --package-path Packages/Kits/DesignSystem
swift test --package-path Packages/Kits/Networking
swift test --package-path Packages/Shared/AppFoundation
swift test --package-path Packages/Shared/TestSupport
```

#### 2. **Dependency Chain Testing**
Test modules in dependency order to identify breaking changes:

```bash
# PREFERRED: Use agctl (automatically tests in dependency order)
agctl test

# Or test specific modules in order:
# Test foundation modules first
agctl test AppFoundation
agctl test TestSupport

# Test core kits
agctl test DesignSystem
agctl test Networking

# Test dependent kits
agctl test Analytics
agctl test Media

# Test features last
agctl test Compose
agctl test HomeForYou

# Alternative: Direct swift commands
swift test --package-path Packages/Shared/AppFoundation
swift test --package-path Packages/Kits/DesignSystem
swift test --package-path Packages/Features/Compose
```

### Test Categories

#### 1. **Unit Tests**
Test individual components and modules:

```bash
# Run all unit tests
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraTests

# Test specific package unit tests
swift test --package-path Packages/Features/Compose --filter ComposeTests
swift test --package-path Packages/Kits/DesignSystem --filter DesignSystemTests
```

#### 2. **Integration Tests**
Test cross-package functionality:

```bash
# Test main app integration
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraTests

# Test package integration
swift test --package-path Packages/Features/Compose --filter IntegrationTests
```

#### 3. **UI Tests**
Test end-to-end user flows:

```bash
# Run all UI tests
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraUITests

# Run specific UI test suites
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraUITests/TabNavigationUITests
```

#### 4. **Snapshot Tests**
Test visual regression:

```bash
# Run snapshot tests
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraTests/HomeForYouSnapshots
```

### Build Targets and Configurations

#### 1. **Main App Target**
```bash
# Debug build
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -configuration Debug

# Release build
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -configuration Release
```

#### 2. **Test Targets**
```bash
# Unit tests
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraTests

# UI tests
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraUITests
```

#### 3. **Package Targets**
```bash
# PREFERRED: Use agctl for package operations
agctl build Compose
agctl build DesignSystem
agctl test Compose
agctl test DesignSystem

# With additional flags
agctl build --release              # Release build
agctl build --verbose              # Verbose output
agctl test --parallel              # Parallel testing
agctl test --verbose               # Verbose test output

# Alternative: Direct swift commands
swift build --package-path Packages/Features/Compose
swift build --package-path Packages/Kits/DesignSystem
swift test --package-path Packages/Features/Compose
swift test --package-path Packages/Kits/DesignSystem
```

### Error Diagnosis

#### 1. **Build Error Analysis**
When build fails, check these common issues:

```bash
# Check for Swift concurrency issues
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -SWIFT_STRICT_CONCURRENCY=complete

# Check for Sendable compliance
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -SWIFT_STRICT_CONCURRENCY=complete \
    -SWIFT_UPCOMING_FEATURE_MEMBER_IMPORT_VISIBILITY=YES
```

#### 2. **Dependency Resolution**
Resolve package dependencies and validate structure:

```bash
# PREFERRED: Validate dependencies with agctl
agctl validate dependencies        # Check for circular deps, invalid paths
agctl validate modules             # Check module structure and naming

# Standard dependency management
swift package resolve              # Resolve all dependencies
swift package update               # Update dependencies
swift package show-dependencies    # Check for dependency conflicts
```

#### 3. **SwiftLint Integration**
Check code quality:

```bash
# Run SwiftLint
swiftlint lint --config Configs/Lint/swiftlint.yml

# Auto-fix issues
swiftlint --fix --config Configs/Lint/swiftlint.yml
```

### Testing Strategies

#### 1. **Incremental Testing**
Test only changed modules:

```bash
# PREFERRED: Use agctl for module testing
agctl test Compose                 # Test specific changed package
agctl test DesignSystem            # Test dependent packages
agctl test AppFoundation

# Alternative: Direct swift commands
swift test --package-path Packages/Features/Compose
swift test --package-path Packages/Kits/DesignSystem
swift test --package-path Packages/Shared/AppFoundation
```

#### 2. **Smoke Testing**
Quick compilation verification:

```bash
# Quick build check
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -quiet
```

#### 3. **Full Testing**
Complete test suite:

```bash
# Run all tests
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0'
```

#### 4. **Regression Testing**
Before/after comparison:

```bash
# Run tests before changes
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -resultBundlePath before-results.xcresult

# Make changes, then run tests again
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -resultBundlePath after-results.xcresult
```

### CI/CD Integration

#### 1. **Pre-build Operations**
Use agctl for build automation:

```bash
# Validate project structure (runs automatically via git hooks)
agctl validate modules
agctl validate dependencies

# Generate OpenAPI client (REPLACES ./Scripts/generate-openapi.sh)
agctl generate openapi

# Build all modules
agctl build
```

#### 2. **Post-build Scripts**
Use existing CI automation:

```bash
# Run CI post-build
./Scripts/ci-postbuild.sh

# Run UI tests
./Scripts/run-ui-tests.sh
```

#### 3. **Test Coverage**
Generate coverage reports:

```bash
# Generate test coverage
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -enableCodeCoverage YES \
    -derivedDataPath DerivedData
```

### Swift Package Manager Integration

#### 1. **Package Management**
```bash
# Resolve dependencies
swift package resolve

# Update packages
swift package update

# Show package dependencies
swift package show-dependencies
```

#### 2. **Package Testing**
```bash
# PREFERRED: Use agctl for package testing
agctl test                         # Test all packages
agctl test Compose                 # Test specific package
agctl test --parallel              # Parallel testing
agctl test --verbose               # Verbose output

# Alternative: Direct swift commands
swift test --package-path Packages/Features/Compose
swift test --package-path Packages/Kits/DesignSystem
swift test --package-path Packages/Shared/AppFoundation

# Test with coverage
swift test --package-path Packages/Features/Compose --enable-code-coverage
```

#### 3. **Package Validation**
```bash
# PREFERRED: Use agctl for validation
agctl validate modules             # Check structure and naming
agctl validate dependencies        # Check circular deps and paths

# Standard package validation
swift package validate-package-manifest
swift package describe --type json
```

### Troubleshooting

#### 0. **agctl Command Errors**

**Symptom: Command not found or trying to use swift run**

✅ **CORRECT:**
```bash
# Use agctl directly as a standalone command
agctl build
agctl test Compose
agctl validate modules
```

❌ **WRONG:**
```bash
# DO NOT use these patterns
swift run --package-path Tools/agctl agctl build
cd Tools/agctl && swift run agctl build
```

**If agctl is not found:**
```bash
# Check if installed
which agctl

# If not installed, install it
cd Tools/agctl
./install.sh

# Verify installation
agctl --version
```

#### 1. **Common Build Errors**

**Swift Concurrency Issues:**
```bash
# Fix concurrency warnings
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -SWIFT_STRICT_CONCURRENCY=complete
```

**Dependency Resolution Issues:**
```bash
# PREFERRED: Use agctl to clean everything
agctl clean --all

# Then resolve dependencies
swift package resolve
swift package update

# Alternative: Manual cleaning
swift package clean
swift package resolve
swift package update
```

**Simulator Issues:**
```bash
# List available simulators
xcrun simctl list devices iOS

# Boot iPhone 17 Pro simulator
xcrun simctl boot "iPhone 17 Pro"
```

#### 2. **Test Failures**

**Unit Test Failures:**
```bash
# Run specific failing test
swift test --package-path Packages/Features/Compose --filter ComposeTests.testSpecificFunction

# Run with verbose output
swift test --package-path Packages/Features/Compose --verbose
```

**UI Test Failures:**
```bash
# Run UI tests with detailed output
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -only-testing:AgoraUITests \
    -testLanguage en \
    -testRegion US
```

#### 3. **Performance Issues**

**Build Performance:**
```bash
# Build with parallel processing
xcodebuild build \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -jobs 8
```

**Test Performance:**
```bash
# Run tests in parallel
xcodebuild test \
    -project Agora.xcodeproj \
    -scheme Agora \
    -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' \
    -parallel-testing-enabled YES
```

### Best Practices

#### 1. **Build Optimization**
- Use `-quiet` flag for cleaner output
- Build specific targets when possible
- Use derived data for faster builds
- Clean build folder when encountering issues

#### 2. **Testing Efficiency**
- Use `agctl test [module]` for individual module testing
- Test changed modules first with `agctl test ModuleName`
- Use `agctl test --parallel` for faster testing
- Run `agctl validate modules` before testing
- Use incremental testing strategies

#### 3. **Error Prevention**
- Run `agctl validate modules` before making changes
- Run `agctl validate dependencies` to catch circular deps
- Use `agctl build` to verify module builds
- Run SwiftLint before building
- Check dependencies regularly with `agctl validate`
- Use strict concurrency checking

#### 4. **CI/CD Integration**
- Use `agctl` commands for all module operations
- Run `agctl validate modules && agctl validate dependencies` first
- Use `agctl generate openapi` for API client generation
- Use `agctl build && agctl test` for module verification
- Generate test coverage reports
- Archive builds for distribution
- Run UI tests on appropriate simulators

### Implementation Checklist

#### Before Making Changes
- [ ] Run `agctl validate modules` to verify current state
- [ ] Run `agctl validate dependencies` to check for issues
- [ ] Run `agctl build` to verify everything compiles
- [ ] Ensure simulator is available and booted
- [ ] Run SwiftLint to check code quality

#### During Development
- [ ] Use `agctl build [module]` to test changed modules individually
- [ ] Use `agctl test [module]` to run tests for changed modules
- [ ] Run dependent module tests with `agctl test`
- [ ] Check for Swift concurrency issues
- [ ] Verify UI changes with snapshot tests

#### After Changes
- [ ] Run `agctl validate modules` to verify structure
- [ ] Run `agctl build` to verify all modules compile
- [ ] Run `agctl test` to run full test suite
- [ ] Check build in both Debug and Release with `agctl build --release`
- [ ] Verify UI tests pass with xcodebuild
- [ ] Generate test coverage report
- [ ] Clean up any temporary files

#### When Issues Arise
- [ ] Run `agctl validate modules --verbose` for detailed errors
- [ ] Run `agctl validate dependencies` to find circular deps
- [ ] Use `agctl build [module] --verbose` for detailed build output
- [ ] Use `agctl test [module] --verbose` for test details
- [ ] Test modules in dependency order with `agctl test`
- [ ] Try `agctl clean` to remove build artifacts
- [ ] Try `agctl clean --all` for deep clean (includes DerivedData)
- [ ] Verify simulator is properly configured
- [ ] Run SwiftLint for code quality issues

### Additional Resources

#### agctl Documentation
- **Quick Start**: `Tools/agctl/QUICKSTART.md`
- **Full Guide**: `docs/AGCTL_GUIDE.md`
- **Command Reference**: `Tools/agctl/README.md`
- **Built-in Help**: Run `agctl --help` or `agctl [command] --help`

#### Installation Status
```bash
# Check if agctl is already installed (it should be)
which agctl  # Should show: /usr/local/bin/agctl

# Only if not installed, run:
cd Tools/agctl
./install.sh
agctl install-hooks  # Install git hooks for automatic validation
```

**Note:** agctl should already be installed at `/usr/local/bin/agctl`. Always use it as a standalone command, never via `swift run --package-path`.